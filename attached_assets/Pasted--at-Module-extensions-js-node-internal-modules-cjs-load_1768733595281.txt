 at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
    at Module.load (node:internal/modules/cjs/loader:1266:32)
    at Module._load (node:internal/modules/cjs/loader:1091:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
    at node:internal/main/run_main_module:28:49 {
  code: 'ERR_INVALID_URL',
  input: 'postgresql://postgres.ronwuihuduazbasbjlbd:<aImv3VrRbCXMgnkN>@aws-0-<Virginia>.p'
}
/app/dist/index.cjs:1
"use strict";var kt=Object.create;var ne=Object.defineProperty;var Nt=Object.getOwnPropertyDescriptor;var Ct=Object.getOwnPropertyNames;var xt=Object.getPrototypeOf,Pt=Object.prototype.hasOwnProperty;var Je=(t,e)=>{for(var r in e)ne(t,r,{get:e[r],enumerable:!0})},De=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ct(e))!Pt.call(t,n)&&n!==r&&ne(t,n,{get:()=>e[n],enumerable:!(s=Nt(e,n))||s.enumerable});return t};var A=(t,e,r)=>(r=t!=null?kt(xt(t)):{},De(e||!t||!t.__esModule?ne(r,"default",{value:t,enumerable:!0}):r,t)),Ut=t=>De(ne({},"__esModule",{value:!0}),t);var kr={};Je(kr,{log:()=>Ue});module.exports=Ut(kr);var me=A(require("express"),1);var Ce=A(require("multer"),1);var fe={};Je(fe,{bulkJobItems:()=>x,bulkJobItemsRelations:()=>jt,bulkJobs:()=>P,bulkJobsRelations:()=>Dt,companies:()=>E,companiesRelations:()=>Tt,contacts:()=>S,contactsRelations:()=>Jt,enrichmentErrors:()=>Lt,insertBulkJobItemSchema:()=>zt,insertBulkJobSchema:()=>Ft,insertCompanySchema:()=>Mt,insertContactSchema:()=>$t,insertSettingsSchema:()=>Ht,reports:()=>oe,reportsRelations:()=>Ot,sessions:()=>Bt,settings:()=>F,users:()=>X});var U=require("drizzle-orm"),l=require("drizzle-orm/pg-core"),Y=require("drizzle-zod");var je=require("drizzle-orm"),I=require("drizzle-orm/pg-core"),Bt=(0,I.pgTable)("sessions",{sid:(0,I.varchar)("sid").primaryKey(),sess:(0,I.jsonb)("sess").notNull(),expire:(0,I.timestamp)("expire").notNull()},t=>[(0,I.index)("IDX_session_expire").on(t.expire)]),X=(0,I.pgTable)("users",{id:(0,I.varchar)("id").primaryKey().default(je.sql`gen_random_uuid()`),email:(0,I.varchar)("email").unique(),firstName:(0,I.varchar)("first_name"),lastName:(0,I.varchar)("last_name"),profileImageUrl:(0,I.varchar)("profile_image_url"),createdAt:(0,I.timestamp)("created_at").defaultNow(),updatedAt:(0,I.timestamp)("updated_at").defaultNow()});var E=(0,l.pgTable)("companies",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),name:(0,l.text)("name").notNull(),domain:(0,l.text)("domain").unique(),linkedinUrl:(0,l.text)("linkedin_url"),isHvac:(0,l.boolean)("is_hvac").default(!1),isRoofing:(0,l.boolean)("is_roofing").default(!1),enrichmentStatus:(0,l.text)("enrichment_status").default("pending"),fullData:(0,l.jsonb)("full_data")}),S=(0,l.pgTable)("contacts",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),email:(0,l.text)("email").unique(),phone:(0,l.text)("phone"),firstName:(0,l.text)("first_name"),lastName:(0,l.text)("last_name"),title:(0,l.text)("title"),city:(0,l.text)("city"),companyId:(0,l.uuid)("company_id").references(()=>E.id),linkedinUrl:(0,l.text)("linkedin_url"),linkedinProfileId:(0,l.text)("linkedin_profile_id").unique(),dataQualityScore:(0,l.numeric)("data_quality_score"),lastEnriched:(0,l.timestamp)("last_enriched")}),P=(0,l.pgTable)("bulk_jobs",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),name:(0,l.text)("name").notNull(),sourceFormat:(0,l.text)("source_format"),totalRecords:(0,l.integer)("total_records"),status:(0,l.text)("status").default("pending"),progress:(0,l.integer)("progress").default(0),successful:(0,l.integer)("successful").default(0),failed:(0,l.integer)("failed").default(0),duplicatesFound:(0,l.integer)("duplicates_found").default(0),checkpointPosition:(0,l.integer)("checkpoint_position").default(0),lastError:(0,l.text)("last_error"),errorLog:(0,l.jsonb)("error_log"),startedAt:(0,l.timestamp)("started_at"),completedAt:(0,l.timestamp)("completed_at")}),x=(0,l.pgTable)("bulk_job_items",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),bulkJobId:(0,l.uuid)("bulk_job_id").notNull().references(()=>P.id,{onDelete:"cascade"}),rowNumber:(0,l.integer)("row_number"),status:(0,l.text)("status").default("pending"),rawData:(0,l.jsonb)("raw_data"),parsedData:(0,l.jsonb)("parsed_data"),companyId:(0,l.uuid)("company_id").references(()=>E.id),contactId:(0,l.uuid)("contact_id").references(()=>S.id),fitScore:(0,l.numeric)("fit_score"),summary:(0,l.jsonb)("summary"),retryCount:(0,l.integer)("retry_count").default(0),lastError:(0,l.text)("last_error"),nextRetryAt:(0,l.timestamp)("next_retry_at"),matchedContactId:(0,l.uuid)("matched_contact_id").references(()=>S.id),matchConfidence:(0,l.numeric)("match_confidence"),enrichmentData:(0,l.jsonb)("enrichment_data"),scrapeSources:(0,l.jsonb)("scrape_sources"),personalizationBullets:(0,l.text)("personalization_bullets").array(),icebreaker:(0,l.text)("icebreaker"),confidenceScore:(0,l.numeric)("confidence_score"),confidenceRationale:(0,l.text)("confidence_rationale")}),Lt=(0,l.pgTable)("enrichment_errors",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),bulkJobItemId:(0,l.uuid)("bulk_job_item_id").references(()=>x.id),errorType:(0,l.text)("error_type"),errorMessage:(0,l.text)("error_message"),errorDetails:(0,l.jsonb)("error_details"),isRecoverable:(0,l.boolean)("is_recoverable").default(!0)}),oe=(0,l.pgTable)("reports",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),contactId:(0,l.uuid)("contact_id").references(()=>S.id),fitScore:(0,l.numeric)("fit_score"),summary:(0,l.text)("summary"),talkingPoints:(0,l.text)("talking_points").array(),risks:(0,l.text)("risks").array(),websiteData:(0,l.jsonb)("website_data"),linkedinData:(0,l.jsonb)("linkedin_data")}),Tt=(0,U.relations)(E,({many:t})=>({contacts:t(S)})),Jt=(0,U.relations)(S,({one:t,many:e})=>({company:t(E,{fields:[S.companyId],references:[E.id]}),reports:e(oe)})),Dt=(0,U.relations)(P,({many:t})=>({items:t(x)})),jt=(0,U.relations)(x,({one:t})=>({bulkJob:t(P,{fields:[x.bulkJobId],references:[P.id]}),company:t(E,{fields:[x.companyId],references:[E.id]}),contact:t(S,{fields:[x.contactId],references:[S.id]})})),Ot=(0,U.relations)(oe,({one:t})=>({contact:t(S,{fields:[oe.contactId],references:[S.id]})})),Mt=(0,Y.createInsertSchema)(E).omit({id:!0,createdAt:!0}),$t=(0,Y.createInsertSchema)(S).omit({id:!0,createdAt:!0}),Ft=(0,Y.createInsertSchema)(P).omit({id:!0,createdAt:!0}),zt=(0,Y.createInsertSchema)(x).omit({id:!0,createdAt:!0}),F=(0,l.pgTable)("settings",{id:(0,l.uuid)("id").primaryKey().default(U.sql`gen_random_uuid()`),createdAt:(0,l.timestamp)("created_at").defaultNow(),updatedAt:(0,l.timestamp)("updated_at").defaultNow(),webhookUrl:(0,l.text)("webhook_url"),apiKeyEnabled:(0,l.boolean)("api_key_enabled").default(!1),emailNotifications:(0,l.boolean)("email_notifications").default(!1),autoRetryEnabled:(0,l.boolean)("auto_retry_enabled").default(!0),maxRetries:(0,l.integer)("max_retries").default(3)}),Ht=(0,Y.createInsertSchema)(F).omit({id:!0,createdAt:!0,updatedAt:!0});var Oe=require("drizzle-orm/node-postgres"),Me=A(require("pg"),1);var{Pool:qt}=Me.default,ie=process.env.DATABASE_URL;console.log("[DB] DATABASE_URL present:",!!ie);console.log("[DB] DATABASE_URL starts with:",ie?.substring(0,30)+"...");if(!ie)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");var W;try{let t=new URL(ie);W={host:t.hostname,port:parseInt(t.port)||5432,database:t.pathname.slice(1),user:t.username,password:decodeURIComponent(t.password),ssl:{rejectUnauthorized:!1}},console.log("[DB] Parsed config - host:",W.host,"port:",W.port,"database:",W.database)}catch(t){throw console.error("[DB] Failed to parse DATABASE_URL:",t),new Error("Invalid DATABASE_URL format")}var Xt=new qt(W),_=(0,Oe.drizzle)(Xt,{schema:fe});var N=require("drizzle-orm"),ge=class{async getCompany(e){let[r]=await _.select().from(E).where((0,N.eq)(E.id,e));return r||void 0}async getCompanyByDomain(e){let[r]=await _.select().from(E).where((0,N.eq)(E.domain,e));return r||void 0}async getCompanyByName(e){let[r]=await _.select().from(E).where((0,N.eq)(E.name,e));return r||void 0}async createCompany(e){let[r]=await _.insert(E).values(e).returning();return r}async upsertCompany(e){if(e.domain){let r=await this.getCompanyByDomain(e.domain);if(r){let[s]=await _.update(E).set(e).where((0,N.eq)(E.id,r.id)).returning();return s}}return this.createCompany(e)}async getContact(e){let[r]=await _.select().from(S).where((0,N.eq)(S.id,e));return r||void 0}async getContactByEmail(e){let[r]=await _.select().from(S).where((0,N.eq)(S.email,e.toLowerCase()));return r||void 0}async getContactByCompanyAndCity(e,r){let s=await this.getCompanyByName(e);if(!s)return;let[n]=await _.select().from(S).where((0,N.eq)(S.companyId,s.id));if(n&&n.city?.toLowerCase()===r.toLowerCase())return n}async getContacts(e=100){return _.select().from(S).orderBy((0,N.desc)(S.createdAt)).limit(e)}async createContact(e){let[r]=await _.insert(S).values({...e,email:e.email?.toLowerCase()}).returning();return r}async upsertContact(e){if(e.email){let r=await this.getContactByEmail(e.email);if(r){let[s]=await _.update(S).set({...e,email:e.email.toLowerCase()}).where((0,N.eq)(S.id,r.id)).returning();return s}}return this.createContact(e)}async getBulkJob(e){let[r]=await _.select().from(P).where((0,N.eq)(P.id,e));return r||void 0}async getBulkJobs(e=20){return _.select().from(P).orderBy((0,N.desc)(P.createdAt)).limit(e)}async createBulkJob(e){let[r]=await _.insert(P).values(e).returning();return r}async updateBulkJob(e,r){let[s]=await _.update(P).set(r).where((0,N.eq)(P.id,e)).returning();return s||void 0}async getBulkJobItems(e){return _.select().from(x).where((0,N.eq)(x.bulkJobId,e))}async createBulkJobItems(e){return e.length===0?[]:_.insert(x).values(e).returning()}async updateBulkJobItem(e,r){let[s]=await _.update(x).set(r).where((0,N.eq)(x.id,e)).returning();return s||void 0}async getBulkJobStats(e){let r=await this.getBulkJobItems(e);return{total:r.length,completed:r.filter(s=>s.status==="complete").length,failed:r.filter(s=>s.status==="failed").length,processing:r.filter(s=>s.status==="processing").length}}async getSettings(){let[e]=await _.select().from(F).limit(1);return e||void 0}async upsertSettings(e){let r=await this.getSettings();if(r){let[n]=await _.update(F).set({...e,updatedAt:new Date}).where((0,N.eq)(F.id,r.id)).returning();return n}let[s]=await _.insert(F).values(e).returning();return s}},h=new ge;var C=require("zod"),He=A(require("papaparse"),1),y={MAX_RECORDS:1e4,MAX_FILE_SIZE_MB:10,MAX_EMAIL_LENGTH:254,MAX_FIELD_LENGTH:500,MIN_EMAIL_LENGTH:5},qe=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,$e=C.z.object({firstName:C.z.string().max(y.MAX_FIELD_LENGTH).optional().or(C.z.literal("")),lastName:C.z.string().max(y.MAX_FIELD_LENGTH).optional().or(C.z.literal("")),email:C.z.string().min(y.MIN_EMAIL_LENGTH).max(y.MAX_EMAIL_LENGTH).toLowerCase().refine(t=>qe.test(t),{message:"Invalid email format"}).optional(),phone:C.z.string().max(50).optional(),title:C.z.string().max(y.MAX_FIELD_LENGTH).optional(),company:C.z.string().max(y.MAX_FIELD_LENGTH).optional(),companyDomain:C.z.string().max(y.MAX_FIELD_LENGTH).optional(),linkedinUrl:C.z.string().max(500).url().optional().or(C.z.literal("")),city:C.z.string().max(y.MAX_FIELD_LENGTH).optional().or(C.z.literal(""))}).refine(t=>t.email||t.phone||t.linkedinUrl,"At least email, phone, or LinkedIn URL required");function Fe(t){return!t||typeof t!="string"?"":t.trim().replace(/[\x00-\x1F\x7F]/g,"").slice(0,y.MAX_FIELD_LENGTH)}function he(t){if(!t||typeof t!="string")return;let e=t.trim().toLowerCase();if(!(e.length<y.MIN_EMAIL_LENGTH)&&!(e.length>y.MAX_EMAIL_LENGTH)&&qe.test(e))return e}function ze(t){if(!t||typeof t!="string")return;let e=t.replace(/[^\d+]/g,"");if(!(e.length<7||e.length>20))return e}var Z=class{static parseCSV(e){let r=[],s=[],n=[],o=new Set,i=new Set;if(Buffer.byteLength(e,"utf8")/(1024*1024)>y.MAX_FILE_SIZE_MB)return{records:[],errors:[{rowNumber:0,field:"file",message:`File exceeds ${y.MAX_FILE_SIZE_MB}MB limit`}],stats:{total:0,valid:0,invalid:1,errorRate:100},warnings:[]};let a=He.default.parse(e,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,transformHeader:p=>p.trim().toLowerCase().replace(/[^\w]/g,"_")});if(a.errors.length>0)return{records:[],errors:a.errors.map((p,g)=>({rowNumber:p.row??g,field:"csv",message:p.message})),stats:{total:0,valid:0,invalid:a.errors.length,errorRate:100},warnings:[]};let u=a.data;u.length>y.MAX_RECORDS&&n.push(`File contains ${u.length} records. Only first ${y.MAX_RECORDS} will be processed.`);let d=u.slice(0,y.MAX_RECORDS);d.forEach((p,g)=>{let b=g+2,R=this.mapRow(p);if(R.email&&(R.email=he(R.email)),R.phone&&(R.phone=ze(R.phone)),R.email&&i.has(R.email)){n.push(`Row ${b}: Duplicate email "${R.email}" within import - skipped`);return}let v=$e.safeParse(R);v.success?(r.push(v.data),v.data.email&&i.add(v.data.email)):(o.add(b),v.error.errors.forEach(f=>{s.push({rowNumber:b,field:String(f.path[0]||"unknown"),message:f.message})}))});let m=o.size;return{records:r,errors:s.slice(0,100),stats:{total:d.length,valid:r.length,invalid:m,errorRate:d.length>0?Math.round(m/d.length*100):0},warnings:n}}static parseEmailList(e){let r=[],s=[],n=[],o=new Set,i=0,c=e.split(`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
Error: Invalid DATABASE_URL format
    at Object.<anonymous> (/app/dist/index.cjs:1:7572)
    at Module._compile (node:internal/modules/cjs/loader:1521:14)
    at Module._extensions..js (node:internal/modules/cjs/loader:1623:10)
    at Module.load (node:internal/modules/cjs/loader:1266:32)
    at Module._load (node:internal/modules/cjs/loader:1091:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:164:12)
    at node:internal/main/run_main_module:28:49
Node.js v20.20.0